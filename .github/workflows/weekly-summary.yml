name: Weekly Summary

on:
  schedule:
    - cron: '10 03 * * 3'  # 毎週水曜 12:10 JST
  workflow_dispatch:  # 手動実行も可能

jobs:
  generate-summary:
    runs-on: ubuntu-latest

    steps:
    - name: Set up GitHub CLI
      run: |
        echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
        gh auth status || echo "GitHub CLIの認証に問題があります"
  
    - name: Checkout dd2030-website repository
      uses: actions/checkout@v2
      with:
        path: dd2030-website

    - name: Checkout oss_weekly_reporter repository (main branch)
      uses: actions/checkout@v2
      with:
        repository: nishio/oss_weekly_reporter
        ref: main
        path: oss_weekly_reporter

    - name: Get latest data directory
      id: get_latest_data
      run: |
        latest_data_dir=$(git -C oss_weekly_reporter ls-tree -d --name-only origin/data data/ | sort | tail -n 1)
        echo "latest_data_dir=${latest_data_dir}" >> $GITHUB_ENV
        echo "Latest data directory: ${latest_data_dir}"

    - name: Fetch data directory from data branch
      run: |
        git -C oss_weekly_reporter fetch origin data:data-branch
        git -C oss_weekly_reporter checkout data-branch -- ${{ env.latest_data_dir }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies (oss_weekly_reporter)
      working-directory: oss_weekly_reporter
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    # - name: Generate OpenAI summary for Slack data
    #   working-directory: oss_weekly_reporter
    #   env:
    #     OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    #   run: |
    #     python -m src.call_openai_api slack --all-summary

    # - name: Generate OpenAI summary for GitHub data (kouchou-ai)
    #   working-directory: oss_weekly_reporter
    #   env:
    #     OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    #   run: |
    #     python -m src.call_openai_api github --repo "digitaldemocracy2030/kouchou-ai" --prompt-file "./prompts/kouchou_prompt.txt"

    - name: Generate OpenAI summary for GitHub data (idobata)
      working-directory: oss_weekly_reporter
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
         python -m src.call_openai_api github --repo "digitaldemocracy2030/idobata" --prompt-file "./prompts/idobata_prompt.txt"

    # - name: Generate OpenAI summary for GitHub data (website)
    #   working-directory: oss_weekly_reporter
    #   env:
    #     OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    #   run: |
    #     python -m src.call_openai_api github --repo "digitaldemocracy2030/website" --prompt-file "./prompts/website_prompt.txt"

    # - name: Generate OpenAI summary for GitHub data (polimoney)
    #   working-directory: oss_weekly_reporter
    #   env:
    #     OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    #   run: |
    #     python -m src.call_openai_api github --repo "digitaldemocracy2030/polimoney" --prompt-file "./prompts/polimoney_prompt.txt"

    - name: Copy summary data to working directory
      run: |
        # env.latest_data_dir 例: data/2025-08-20_to_2025-08-27
        name=$(basename "${{ env.latest_data_dir }}")   # -> 2025-08-20_to_2025-08-27
        # 末尾の終了日を YYYYMMDD に変換
        end_date=$(echo "$name" | sed -E 's/.*_to_([0-9]{4})-([0-9]{2})-([0-9]{2})$/\1\2\3/')

        # history 内の最後の weekN を探して +1
        last_weekly_num=$(ls -1 dd2030-website/markdown/history 2>/dev/null \
          | grep -E '^week[0-9]+_' \
          | sed -E 's/^week([0-9]+)_.*/\1/' \
          | sort -n \
          | tail -n1 || true)
        last_weekly_num=${last_weekly_num:-0}
        next_weekly_num=$((last_weekly_num + 1))
        dest="dd2030-website/markdown/history/week${next_weekly_num}_${end_date}"
        mkdir -p "$dest"
        cp -r oss_weekly_reporter/${{ env.latest_data_dir }}/ai_reports/* "$dest/"
        ls -l "$dest"

        echo "next_weekly_num=${next_weekly_num}" >> $GITHUB_ENV
        echo "end_date=${end_date}" >> $GITHUB_ENV

    - name: Create Pull Request with summaries
      uses: peter-evans/create-pull-request@v3
      with:
        branch: week${{ env.next_weekly_num }}
        base: main
        title: "Week${{ env.next_weekly_num }} Summary Update"
        body: "Auto-generated weekly summaries for week${{ env.next_weekly_num }}"
        commit-message: "Week${{ env.next_weekly_num }} Summary Update"
        paths: |
          markdown/history/week${{ env.next_weekly_num }}_${{ env.end_date }}/*.md
        draft: true
